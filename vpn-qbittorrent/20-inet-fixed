#!/bin/bash
# Fixed version of the nordlynx 20-inet init script
# This fixes the hostname resolution issue in iptables rules

set -e

echo "[$(date -Iseconds)] Setting up network interface..."

# Get the interface name (usually eth0, eth1, etc for physical interfaces)
phys_iface=$(ip route | grep "^default" | awk '{print $5}' | head -n 1)
if [ -z "$phys_iface" ]; then
    phys_iface="eth0"
fi

echo "[$(date -Iseconds)] Using physical interface: $phys_iface"

# Allow DNS traffic on the physical interface BEFORE firewall rules are fully applied
# This allows the container to resolve hostnames before the tunnel is up
echo "[$(date -Iseconds)] Allowing DNS traffic on physical interface..."
iptables -A OUTPUT -o "$phys_iface" -p udp --dport 53 -j ACCEPT
iptables -A OUTPUT -o "$phys_iface" -p tcp --dport 53 -j ACCEPT

# Allow traffic to NordVPN API on physical interface
echo "[$(date -Iseconds)] Allowing NordVPN API access..."
iptables -A OUTPUT -o "$phys_iface" -d 45.137.184.0/24 -p tcp --dport 443 -j ACCEPT
iptables -A OUTPUT -o "$phys_iface" -d 45.137.185.0/24 -p tcp --dport 443 -j ACCEPT

echo "[$(date -Iseconds)] Network interface setup completed"
