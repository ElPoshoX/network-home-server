---
volumes:
  nordlynx_config:
  qbittorrent_config:
  prometheus_config:
  prometheus_data:
  grafana_data:

networks:
  networks_vpn_net:
    external: true
  networks_infra_net:
    external: true

services:
  # ðŸ”’ NordLynx (WireGuard de NordVPN)
  nordlynx:
    image: ghcr.io/bubuntux/nordlynx:latest
    container_name: nordlynx
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    environment:
      - PRIVATE_KEY=${NORDLYNX_PRIVATE_KEY}
      - DNS=103.86.96.100,103.86.99.100
      # - DNS=8.8.8.8,1.1.1.1
    volumes:
      - nordlynx_config:/config
    networks:
      - networks_vpn_net
      - networks_infra_net

  # ðŸ’¾ qBittorrent â€” routed through NordLynx
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: service:nordlynx
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Mexico_City
      - WEBUI_PORT=8080
    volumes:
      - qbittorrent_config:/config
      - /mnt/media/downloads:/downloads
    depends_on:
      - nordlynx

  # ðŸ“Š WireGuard Exporter â€” Prometheus metrics for NordLynx tunnel
  wg-exporter:
    image: ghcr.io/mdlayher/wireguard_exporter:latest
    container_name: wg-exporter
    restart: unless-stopped
    network_mode: "host"
    cap_add:
      - NET_ADMIN
    ports:
      - "9586:9586"

  # ðŸ“ˆ Prometheus â€” Metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    ports:
      - "9091:9090"
    networks:
      - networks_infra_net

  # ðŸ“Š Grafana â€” Dashboard visualization
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      - "3000:3000"
    networks:
      - networks_infra_net
    depends_on:
      - prometheus
