---
networks:
  networks_infra_net:
    external: true
  networks_vpn_net:
    external: true

volumes:
  nordlynx_config:

configs:
  nordlynx_init_20_inet:
    external: true
  nordlynx_init_20_inet6:
    external: true

services:
  # ðŸ”’ NordLynx (WireGuard de NordVPN)
  nordlynx:
    image: bubuntux/nordlynx:latest
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: any
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
      - NET_RAW
      - SYS_PTRACE
    privileged: true
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=1
    dns:
      - 127.0.0.11
    dns_search:
      - .
    # Note: Using Docker's internal DNS (127.0.0.11:53)
    # which is more reliable in Swarm environments
    devices:
      - /dev/net/tun:/dev/net/tun
    configs:
      - source: nordlynx_init_20_inet
        target: /etc/cont-init.d/20-inet
        mode: 0755
      - source: nordlynx_init_20_inet6
        target: /etc/cont-init.d/20-inet6
        mode: 0755
    environment:
      - PRIVATE_KEY=${NORDLYNX_PRIVATE_KEY}
      - COUNTRY_CODE=MX
      - TZ=America/Mexico_City
      - NET_LOCAL=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
      - DNS=8.8.8.8,1.1.1.1
      - PUID=911
      - PGID=911
    volumes:
      - nordlynx_config:/config
      - /lib/modules:/lib/modules:ro
      - /usr/src:/usr/src:ro
    networks:
      - networks_vpn_net
      - networks_infra_net
    healthcheck:
      test: ["CMD", "ping", "-c", "1", "1.1.1.1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # # ðŸ’¾ qBittorrent â€” ruteado por NordLynx
  # qbittorrent:
  #   image: lscr.io/linuxserver/qbittorrent:latest
  #   deploy:
  #     mode: replicated
  #     replicas: 1
  #     restart_policy:
  #       condition: any
  #   environment:
  #     - PUID=1000
  #     - PGID=1000
  #     - TZ=America/Mexico_City
  #     - WEBUI_PORT=8080
  #   volumes:
  #     - qbittorrent_config:/config
  #     - /mnt/media/downloads:/downloads
  #   networks:
  #     - vpn-net
  #   depends_on:
  #     - nordlynx
  #   command: >
  #     sh -c "ip route add default via $(getent hosts nordlynx | awk '{print $1}') &&
  #            qbittorrent-nox"
