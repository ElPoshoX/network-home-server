---
networks:
  networks_infra_net:
    external: true
  networks_vpn_net:
    external: true

volumes:
  nordlynx_config:

secrets:
  NORDLYNX_PRIVATE_KEY:
    external: true

services:
  # ðŸ”’ NordLynx (WireGuard de NordVPN)
  nordlynx:
    image: bubuntux/nordlynx:latest
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: any
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
      - NET_RAW
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=1
    # devices:
    #   - /dev/net/tun:/dev/net/tun
    secrets:
      - NORDLYNX_PRIVATE_KEY
    environment:
      - PRIVATE_KEY_FILE=/run/secrets/NORDLYNX_PRIVATE_KEY
      - COUNTRY_CODE=MX
      - TZ=America/Mexico_City
      - NET_LOCAL=1
      - TABLE=auto
      - DNS=103.86.96.100,103.86.99.100
      - TECHNOLOGY=NORDLYNX
    dns:
      - 103.86.96.100
      - 103.86.99.100
    volumes:
      - nordlynx_config:/config
    networks:
      - networks_vpn_net
      - networks_infra_net
    healthcheck:
      test: >
        /bin/sh -c '
        ip link show wg0 >/dev/null 2>&1 &&
        ping -c1 -W3 103.86.96.100 >/dev/null 2>&1 &&
        wg show | grep -q "latest handshake"
        '
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # # ðŸ’¾ qBittorrent â€” ruteado por NordLynx
  # qbittorrent:
  #   image: lscr.io/linuxserver/qbittorrent:latest
  #   deploy:
  #     mode: replicated
  #     replicas: 1
  #     restart_policy:
  #       condition: any
  #   environment:
  #     - PUID=1000
  #     - PGID=1000
  #     - TZ=America/Mexico_City
  #     - WEBUI_PORT=8080
  #   volumes:
  #     - qbittorrent_config:/config
  #     - /mnt/media/downloads:/downloads
  #   networks:
  #     - vpn-net
  #   depends_on:
  #     - nordlynx
  #   command: >
  #     sh -c "ip route add default via $(getent hosts nordlynx | awk '{print $1}') &&
  #            qbittorrent-nox"
